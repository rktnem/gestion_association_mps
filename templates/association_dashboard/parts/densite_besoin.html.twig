<div class="densite-besoin shadow dashboard-component">
    <div class="loading" data-access="loaderOfNeeded">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="header">
        <h3>Besoin</h3>
        <select name="regionInNeed" id="regionInNeed">
            <option value="none">Region</option>
            {% for region in regions %}
                <option value={{ region.id }}>{{ region.nom }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="chart-component">
        <div class="chart">
            <canvas id="chartOfNeeds"></canvas>
        </div>
    </div>
</div>

{# Charge the background color asset to alter the color for each "besoin" #}
<script>
    const chartOfNeeds = document.getElementById("chartOfNeeds")
    const regionInNeed = document.getElementById("regionInNeed")
    let neededChart
    let config = {}
    let loaderOfNeeded = document.querySelectorAll(".loading")

    console.log(loaderOfNeeded[1])

    function showNeeded(needs) {
        let name = []
        let total = []

        if(neededChart) {
            neededChart.destroy()
        }

        for(need of needs) {
            name.push(need.besoin)
            total.push(need.total)
        }

        const data = {
            labels: name,
            datasets: [{
                label: 'Besoin',
                data: total,
                backgroundColor: setColor(needs, color),
            }]
        };

        const config = {
            type: 'polarArea',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onResize: (chart, size) => {
                    size.height = 300
                    chart.update()
                }
            }
        }

        return config
    }

    let needs = {{ besoins|json_encode|raw }}
    // Charge data on loading
    config = showNeeded(needs)

    neededChart = new Chart(chartOfNeeds, config)

    // Charge data when a region was selected
    regionInNeed.onchange = (event) => {
        let regionId = event.target.value

        loaderOfNeeded.style.display = "flex"

        fetch(`/api/besoin/${regionId}`)
        .then(res => {
            return res.json()
        })
        .then(needs => {
            config = showNeeded(needs)

            neededChart = new Chart(chartOfNeeds, config)

            loaderOfNeeded.style.display = "none"
        })
    }

</script>